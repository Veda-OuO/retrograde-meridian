---
import Layout from './_layout.astro';

interface Props {
  mysteryId: string;
}
const { mysteryId } = Astro.props;
---

<Layout title="Exam" pageId="exam" mysteryId={mysteryId} backgroundImage="/assets/exam-crossfire.jpg">
  <div class="title">Exam</div>

  <div class="text-box">
    <p><strong>Exam Rules:</strong></p>
    <p>&nbsp;</p>
    <p>Record your answers here. The solutions are found at the bottom of the Whodunit tab, and some questions require specific names/words (in bold there) to count. Excess random name dumping will invalidate an answer.</p>
  </div>

  <div class="text-box">
    <p><strong>1:</strong> Who killed Emilia Brooks? <strong>(40 points)</strong></p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="1" placeholder="Enter your answer here..."></textarea>
  </div>

  <div class="text-box">
    <p><strong>2:</strong> What were the circumstances that unfolded in the Baggage Car leading up the Emilia's murder? <strong>(50 points)</p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="2" placeholder="Enter your answer here..."></textarea>
  </div>

  <div class="text-box">
    <p><strong>3:</strong> What did the killer take from the scene? <strong>(40 points)</strong></p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="3" placeholder="Enter your answer here..."></textarea>
  </div>

  <div class="text-box">
    <p><strong>4:</strong> What was the nature of Emilia's relationship with the Stantons? <strong>(30 points)</strong></p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="4" placeholder="Enter your answer here..."></textarea>
  </div>

  <div class="text-box">
    <p><strong>5:</strong> What were Robert Stanton's goals for funding the expedition? <strong>(10 points)</strong></p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="5" placeholder="Enter your answer here..."></textarea>
  </div>

  <!-- <div class="text-box">
    <p><strong>6:</strong> Where is Wesley Range? <strong>(30 points)</strong></p>
  </div>
  <div class="notes-container">
    <textarea class="notes-textarea" data-box="6" placeholder="Enter your answer here..."></textarea>
  </div>

  <div class="submit-container">
    <button id="submitAnswers" class="submit-button">Submit Answers</button>
    <div id="submission-status" class="submission-status hidden">
      <p><strong>Answers Submitted!</strong> You may now proceed to the Whodunit tab.</p>
    </div>
  </div>

  <div id="grading-results" class="grading-results hidden" aria-live="polite"></div> -->
</Layout>

<style>
  .title {
    font-size: 100px;
    color: rgb(255, 166, 0);
    text-shadow: 0 0 10px rgb(0, 0, 0);
    padding: 10px;
    margin-bottom: 20px;
  }
  @media (max-width: 768px) {
    .title { font-size: 40px; margin-top: 50px; }
  }
  @media (max-width: 480px) {
    .title { font-size: 30px; }
  }

  .notes-container { margin: 10px 0 30px 0; }
  .notes-textarea {
    width: 80%;
    max-width: 900px;
    padding: 12px;
    font-size: 16px;
    font-family: Georgia, sans-serif;
    border: 2px solid #666;
    border-radius: 5px;
    background-color: rgba(255,255,255,0.9);
    color: #000;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    resize: vertical;
    min-height: 80px;
  }
  .notes-textarea:focus {
    outline: none;
    border-color: #ff6b6b;
    box-shadow: 0 0 5px rgba(255,107,107,0.3);
  }

  .submit-container { text-align: center; margin: 30px 0; }
  .submit-button {
    background-color: #8B0000;
    color: #fff;
    border: none;
    padding: 15px 30px;
    font-size: 18px;
    font-family: Georgia, sans-serif;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    font-weight: bold;
  }
  .submit-button:hover {
    background-color: #a00000;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  .submit-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  .submit-button:disabled {
    background-color: #666;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .submission-status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    background-color: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
    font-size: 16px;
  }
  .submission-status.hidden { display: none; }

  .grading-results {
    max-width: 900px;
    margin: 25px auto 60px;
    padding: 18px 22px;
    background: rgba(0,0,0,0.45);
    border: 2px solid #1e3a8a;
    border-radius: 10px;
    font-family: 'Special Elite','Courier New',monospace;
    color: #f0f0f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  }
  .grading-results.hidden { display: none; }
  .grading-results h3 {
    margin: 0 0 10px 0;
    font-size: 22px;
    color: #ffd25a;
    text-shadow: 0 0 4px #000;
  }
  .grading-results pre {
    margin: 12px 0 0;
    background: rgba(255,255,255,0.08);
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.4;
    overflow-x: auto;
  }
  .grading-summary-line { margin: 4px 0; }
  .score-pass { color: #58d68d; font-weight: bold; }
  .score-fail { color: #ff6b6b; font-weight: bold; }
</style>

<script>
  import { gradeExam } from '../data/examRubric.js';

  interface Grade {
    score: number;
    max: number;
    details: string;
  }

  interface GradingResult {
    total: number;
    max: number;
    breakdown: { [key: string]: Grade };
  }

  function initExamGrader() {
    console.log('[Exam] Initializing grader for Crossfire...');

    // Get mystery ID from the page (passed from Layout)
    const mysteryId = 'crossfire';
    const getKey = (key: string) => `${mysteryId}_${key}`;

    const submitButton = document.getElementById('submitAnswers') as HTMLButtonElement | null;
    const submissionStatus = document.getElementById('submission-status') as HTMLElement | null;
    const textareas = document.querySelectorAll<HTMLTextAreaElement>('.notes-textarea');
    const resultsBox = document.getElementById('grading-results') as HTMLElement | null;

    if (!submitButton || !submissionStatus || !resultsBox) {
      console.warn('[Exam] Required elements missing. Aborting.');
      return;
    }
    if (typeof gradeExam !== 'function') {
      console.error('[Exam] gradeExam not available. Check examRubric.js export.');
      return;
    }

    function collectAnswers(): { [key: string]: string } {
      const map: { [key: string]: string } = {};
      textareas.forEach(t => {
        const id = t.getAttribute('data-box');
        if (id) {
          map[id] = t.value || '';
        }
      });
      return map;
    }

    function lockUI() {
      submitButton!.textContent = 'Answers Submitted';
      submitButton!.disabled = true;
      submissionStatus!.classList.remove('hidden');
      textareas.forEach(t => {
        t.readOnly = true;
        t.style.backgroundColor = 'rgba(240,240,240,0.9)';
        t.style.cursor = 'not-allowed';
      });
    }

    function renderResults(data: GradingResult) {
      const lines = Object.entries(data.breakdown).map(
        ([qid, r]) => `Q${qid}: ${r.score}/${r.max} - ${r.details}`
      );
      const percent = data.max ? Math.round((data.total / data.max) * 100) : 0;
      resultsBox!.innerHTML = `
        <h3>Grading Summary</h3>
        <p><strong>Total Score:</strong> ${data.total}/${data.max} (${percent}%)</p>
        <pre>${lines.join('\n')}</pre>
      `;
      resultsBox!.classList.remove('hidden');
    }

    // Check if exam was already submitted (using namespaced key)
    if (localStorage.getItem(getKey('examSubmitted')) === 'true') {
      console.log('[Exam] Rehydrating previous submission for Crossfire.');
      lockUI();
      try {
        const storedAnswers = JSON.parse(localStorage.getItem(getKey('examAnswers')) || '{}');
        const storedBreakdown = JSON.parse(localStorage.getItem(getKey('examBreakdown')) || '{}') as { [key: string]: Grade };
        let max = 0, total = 0;
        Object.values(storedBreakdown).forEach(r => {
          max += r.max || 0;
          total += r.score || 0;
        });
        if (Object.keys(storedBreakdown).length) {
          renderResults({ total, max, breakdown: storedBreakdown });
        } else {
          const regraded = gradeExam(storedAnswers) as GradingResult;
          renderResults(regraded);
        }
        textareas.forEach(t => {
          const id = t.getAttribute('data-box');
          if (id && storedAnswers[id] != null) {
            t.value = storedAnswers[id];
          }
        });
      } catch (e) {
        console.error('[Exam] Rehydrate error:', e);
      }
    }

    submitButton.addEventListener('click', () => {
      if (localStorage.getItem(getKey('examSubmitted')) === 'true') return;

      const answers = collectAnswers();
      const graded = gradeExam(answers) as GradingResult;

      // Save all exam data with mystery-specific keys
      localStorage.setItem(getKey('examAnswers'), JSON.stringify(answers));
      localStorage.setItem(getKey('examBreakdown'), JSON.stringify(graded.breakdown));
      localStorage.setItem(getKey('examScore'), graded.total.toString());
      localStorage.setItem(getKey('examSubmitted'), 'true');
      localStorage.setItem(getKey('whodunitUnlocked'), 'true');

      lockUI();
      renderResults(graded);

      // Dispatch event so VisitTracker knows to unlock Whodunit
      window.dispatchEvent(new CustomEvent('examCompleted'));

      setTimeout(() => {
        alert('Your answers have been submitted! The Whodunit tab is now unlocked.');
      }, 200);

      console.log('[Exam] Submission complete for Crossfire. Whodunit unlocked.');
    });

    console.log('[Exam] Grader ready for Crossfire.');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExamGrader);
  } else {
    initExamGrader();
  }
</script>